WITH cte AS
(
   SELECT *,AVG(IMU_PERCENTAGE) OVER(PARTITION BY FISCAL_PERIOD_NBR) AS IMU_PERCENTAGE_Agg,
         ROW_NUMBER() OVER (PARTITION BY FISCAL_PERIOD_NBR ORDER BY FISCAL_YR_NBR DESC) AS rn
   FROM `grp-dev-cdp-turing-lan-122.froneri_ch.demo_file_transfer`
)
SELECT FISCAL_YR_NBR+1 FISCAL_YR_NBR,FISCAL_PERIOD_NBR,SBU_NBR,SBU_DESC,LOCAL_CRNCY_AMT,RETAIL_AMT,IMU_PERCENTAGE_Agg IMU_PERCENTAGE
FROM cte
WHERE rn = 1 order by FISCAL_PERIOD_NBR




WITH last_3_years AS
(
   SELECT *,ROW_NUMBER() OVER (PARTITION BY FISCAL_PERIOD_NBR ORDER BY FISCAL_YR_NBR DESC) AS rn
   FROM `grp-dev-cdp-turing-lan-122.froneri_ch.demo_file_transfer`
),
cte AS
(
SELECT FISCAL_YR_NBR,FISCAL_PERIOD_NBR,SBU_NBR,SBU_DESC,LOCAL_CRNCY_AMT,RETAIL_AMT,AVG(IMU_PERCENTAGE) OVER(PARTITION BY FISCAL_PERIOD_NBR) AS IMU_PERCENTAGE_Agg,rn FROM last_3_years
WHERE rn < 4 order by FISCAL_PERIOD_NBR
)
SELECT FISCAL_YR_NBR+1 FISCAL_YR_NBR,FISCAL_PERIOD_NBR,SBU_NBR,SBU_DESC,LOCAL_CRNCY_AMT,RETAIL_AMT,IMU_PERCENTAGE_Agg IMU_PERCENTAGE
FROM cte
WHERE rn = 1 order by FISCAL_PERIOD_NBR

